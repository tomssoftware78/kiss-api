variables:
  CONTAINER_IMAGE: "docker-host.ccuvpndom.com:5000/i2-kiss-api"

image: python:3.13.1-bookworm

stages:
  - build
  - docker_build
  - docker_deploy

build_job:
  stage: build
  script:
    - echo "Installing uv..."
    - pip install uv
    - echo "Building the project..."
    - python -m venv venv #


docker_build_and_push:
  stage: docker_build
  image: docker:27.4.0
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  script:
    - echo "Build Docker Image"
    - ls -la
    - pwd
    - docker info
    - docker build --no-cache -t my-i2-kiss-api-container .
    - docker tag my-i2-kiss-api-container $CONTAINER_IMAGE:$CI_COMMIT_TAG
    - docker image push $CONTAINER_IMAGE:$CI_COMMIT_TAG
  #rules:
  #  - if: '$CI_COMMIT_TAG'


docker_deploy_to_server:
  stage: docker_deploy
  image: docker:27.4.0
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  script:
    - apk add --no-cache rsync
    - echo "Deploying to production server..."
    - mkdir -p ~/.ssh
    - echo "$SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    #- ls -la ~/.ssh
    #- cat ~/.ssh/id_rsa
    #:ad0a4ff7 
    - ssh -o StrictHostKeyChecking=no docker@192.168.70.5 "
        bash -c '
          pwd
          ls -la
          rm -rf i2-kiss-api 
          mkdir i2-kiss-api
        '
      "
    - rm ./docker-compose.yml
    - mv ./docker-compose-prd.yml ./docker-compose.yml
    - pwd
    - ls -la
    - cat ./docker-compose.yml
    - sed -i "s|__DOCKER_TAG__|$CI_COMMIT_TAG|g" docker-compose.yml
    - sed -i "s|__GIT_COMMIT__|$CI_COMMIT_SHORT_SHA|g" .env
    - sed -i "s|__GIT_TAG__|$CI_COMMIT_TAG|g" .env
    - rsync -e "ssh -o StrictHostKeyChecking=no" -avz ./docker-compose.yml docker@192.168.70.5:~/i2-kiss-api
    - rsync -e "ssh -o StrictHostKeyChecking=no" -avz ./.env docker@192.168.70.5:~/i2-kiss-api/.env
    - | 
      ssh -o StrictHostKeyChecking=no docker@192.168.70.5 "
        export CONTAINER_IMAGE_SUB=$CONTAINER_IMAGE;
        export CI_COMMIT_TAG_SUB=$CI_COMMIT_TAG;
        export LOGS_FOLDER_ON_DOCKER_HOST_SUB=$LOGS_FOLDER_ON_DOCKER_HOST
        export OUTPUT_FOLDER_ON_DOCKER_HOST_SUB=$OUTPUT_FOLDER_ON_DOCKER_HOST
        bash -c '
          echo CONTAINER_IMAGE_SUB: \$CONTAINER_IMAGE_SUB; 
          echo CI_COMMIT_TAG_SUB: \$CI_COMMIT_TAG_SUB;
          cd i2-kiss-api
          pwd
          ls -la

          #mkdir -p \$LOGS_FOLDER_ON_DOCKER_HOST_SUB
          #docker stop kiss-data-extraction-tool;
          #docker rm kiss-data-extraction-tool;
          #echo start the container \$CONTAINER_IMAGE_SUB:\$CI_COMMIT_TAG_SUB;
          echo start the container \$CONTAINER_IMAGE_SUB:ad0a4ff7

          echo "Pull nieuwste image"
          docker pull \$CONTAINER_IMAGE_SUB:\$CI_COMMIT_TAG_SUB
          docker compose down
          docker compose up -d
          #docker run -v \$LOGS_FOLDER_ON_DOCKER_HOST_SUB:/logs -v \$OUTPUT_FOLDER_ON_DOCKER_HOST_SUB:/output -d --name kiss-data-extraction-tool -p 9009:8086 #\$CONTAINER_IMAGE_SUB:\$CI_COMMIT_TAG_SUB
        '
      "
#  rules:
#    - if: '$CI_COMMIT_TAG'
  
  

