# Stage 1: Builder
FROM python:3.12 AS Builder

# Install uv binary from it's official docker repository
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install OS-level dependencies(needed for compiling python packages)
RUN apt-get update && apt-get install -y \
apt-utils curl build-essential gcc && rm -rf /var/lib/apt/lists/*

WORKDIR /code-in-docker

# Copy dependency management files
COPY uv.lock .
COPY pyproject.toml .

# Clear uv cache and install dependencies
RUN uv cache clean
RUN uv sync --frozen --compile-bytecode

# Stage 2: Runtime
FROM python:3.12 AS runtime

ENV JAVA_FOLDER=java-se-8u41-ri

ENV JVM_ROOT=/usr/lib/jvm

ENV JAVA_PKG_NAME=openjdk-8u41-b04-linux-x64-14_jan_2020.tar.gz
ENV JAVA_TAR_GZ_URL=https://download.java.net/openjdk/jdk8u41/ri/$JAVA_PKG_NAME

RUN apt-get update && apt-get install -y wget && rm -rf /var/lib/apt/lists/*    && \
    apt-get clean                                                               && \
    apt-get autoremove                                                          && \
    echo Downloading $JAVA_TAR_GZ_URL                                           && \
    wget -q $JAVA_TAR_GZ_URL                                                    && \
    tar -xvf $JAVA_PKG_NAME                                                     && \
    rm $JAVA_PKG_NAME                                                           && \
    mkdir -p /usr/lib/jvm                                                       && \
    mv ./$JAVA_FOLDER $JVM_ROOT                                                 && \
    update-alternatives --install /usr/bin/java java $JVM_ROOT/$JAVA_FOLDER/bin/java 1        && \
    update-alternatives --install /usr/bin/javac javac $JVM_ROOT/$JAVA_FOLDER/bin/javac 1     && \
    java -version

COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Set all environment variables in one command
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1

WORKDIR /code-in-docker

# Copy thevirtual environment from the builder stage
COPY --from=builder /code-in-docker /code-in-docker
COPY ./app/* /code-in-docker
RUN rm /code-in-docker/logging_config.yml
RUN mv /code-in-docker/logging_config_prd.yml /code-in-docker/logging_config.yml


RUN mkdir -p /logs
RUN mkdir -p /output



#
#CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]
CMD ["uv", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]
#If behind proxy
#CMD ["uvicorn", "app.main:app", "--proxy-headers", "--host", "0.0.0.0", "--port", "80"]
